# Opencode 产品优化建议

## 现状分析

### 当前产品形态

Opencode 目前是一个 **Chat-first** 的多 Agent IDE：

```
┌─────────────────────────────────────────────────────────────┐
│  Opencode 当前界面                                           │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────┐  ┌───────────────────────────────────────────┐ │
│  │ 侧边栏  │  │              聊天区域                      │ │
│  │         │  │                                           │ │
│  │ Claude  │  │  User: 帮我修复登录 Bug                   │ │
│  │ Gemini  │  │  Agent: 好的，让我检查代码...             │ │
│  │ Codex   │  │  Agent: 我发现问题在 auth.ts:42...       │ │
│  │ Kiro    │  │                                           │ │
│  │         │  │  [输入框]                                  │ │
│  └─────────┘  └───────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 痛点分析

| 痛点 | 描述 | 影响 |
|------|------|------|
| **单任务串行** | 一次只能处理一个任务，等待 Agent 完成才能开始下一个 | 效率低 |
| **上下文丢失** | 切换 Agent 后，之前的对话上下文丢失 | 重复沟通 |
| **任务不可追溯** | 没有历史任务记录，难以回顾之前的工作 | 管理困难 |
| **无进度可视化** | 不知道整体项目有多少任务、完成了多少 | 缺乏全局视角 |
| **协作困难** | 不同 Agent 之间无法协作或传递上下文 | 能力受限 |

---

## 产品演进路线

### 核心理念

> **从 "Chat with AI" 演进到 "Orchestrate AI Agents"**

不是简单地加一个 Kanban，而是重新思考：**人类工程师如何最高效地利用多个 AI Agent？**

### 三阶段演进

```
Phase 1: Chat+              Phase 2: Task Hub           Phase 3: Agent Orchestra
─────────────────────────   ─────────────────────────   ─────────────────────────
增强现有聊天体验              引入任务概念                  多 Agent 协作编排
• 会话历史持久化              • 并行任务执行                • Agent 间任务传递
• 快速任务切换               • 任务状态追踪                • 智能任务分配
• 上下文保持                 • Git Worktree 隔离           • 工作流自动化
```

---

## Phase 1: Chat+ (增强聊天体验)

**目标**：在不改变主要交互模式的情况下，解决最紧迫的痛点

### 1.1 会话管理增强

```
┌─────────────────────────────────────────────────────────────┐
│  ┌─────────────────┐  ┌─────────────────────────────────┐  │
│  │    会话列表      │  │           聊天区域              │  │
│  │                 │  │                                 │  │
│  │  Claude ▼       │  │                                 │  │
│  │  ├─ 修复登录Bug │  │  User: 帮我修复登录 Bug         │  │
│  │  │   今天 14:30 │  │  Agent: 好的...                 │  │
│  │  ├─ 添加用户模块│  │                                 │  │
│  │  │   昨天       │  │                                 │  │
│  │  └─ 重构API    │  │                                 │  │
│  │      3天前      │  │                                 │  │
│  │                 │  │                                 │  │
│  │  Gemini ▼      │  │                                 │  │
│  │  ├─ 写测试用例  │  │                                 │  │
│  │  └─ ...        │  │                                 │  │
│  └─────────────────┘  └─────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

**功能清单**：
- [x] 会话持久化（已在 SESSION_DATA_STORE.md 设计）
- [ ] 会话标题自动生成（基于首条消息）
- [ ] 会话搜索
- [ ] 会话归档/删除
- [ ] 会话导出（Markdown）

### 1.2 快速任务模式

在聊天基础上增加"快速任务"概念：

```
┌─────────────────────────────────────────────────────────────┐
│  [+ 新任务]  [历史会话 ▼]                      Claude ▼     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 📋 当前任务: 修复登录页面 Bug                        │   │
│  │ 🤖 Agent: Claude  ⏱️ 运行中 3:42                    │   │
│  │ 📁 分支: feature/fix-login-bug                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  聊天内容...                                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**功能清单**：
- [ ] 任务创建（标题 + 描述）
- [ ] 任务与会话绑定
- [ ] 任务状态标记（进行中/完成/暂停）
- [ ] 任务耗时统计

### 1.3 Agent 快速切换

```
┌────────────────────────────────────────┐
│  当前: Claude                          │
│  ─────────────────────────────────────│
│  🔄 切换 Agent 并保持上下文？          │
│                                        │
│  [Gemini]  [Codex]  [Kiro]            │
│                                        │
│  ☑️ 携带最近 10 条消息作为上下文        │
│  ☐ 开始全新对话                        │
└────────────────────────────────────────┘
```

**功能清单**：
- [ ] Agent 切换时可选择携带上下文
- [ ] 上下文摘要（长对话自动总结）
- [ ] Agent 能力提示（哪个 Agent 更适合当前任务）

---

## Phase 2: Task Hub (任务中心)

**目标**：引入任务概念，支持并行执行，提供全局视角

### 2.1 任务面板

```
┌─────────────────────────────────────────────────────────────────┐
│  Opencode  │  💬 聊天  │  📋 任务  │  📁 文件  │  ⚙️ 设置      │
├─────────────────────────────────────────────────────────────────┤
│                        任务面板                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ [+ 新建任务]                          筛选: 全部 ▼       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐              │
│  │ 🔵 进行中   │ │ 🟡 待审核   │ │ 🟢 已完成   │              │
│  │             │ │             │ │             │              │
│  │ ┌─────────┐ │ │ ┌─────────┐ │ │ ┌─────────┐ │              │
│  │ │修复登录 │ │ │ │重构API  │ │ │ │添加测试 │ │              │
│  │ │         │ │ │ │         │ │ │ │         │ │              │
│  │ │🤖Claude │ │ │ │🤖Gemini │ │ │ │🤖Codex  │ │              │
│  │ │⏱️ 5:23  │ │ │ │📝 待合并│ │ │ │✅ 已合并│ │              │
│  │ └─────────┘ │ │ └─────────┘ │ │ └─────────┘ │              │
│  │             │ │             │ │             │              │
│  │ ┌─────────┐ │ │             │ │ ┌─────────┐ │              │
│  │ │优化性能 │ │ │             │ │ │修复样式 │ │              │
│  │ │🤖Kiro   │ │ │             │ │ │🤖Claude │ │              │
│  │ │⏱️ 2:11  │ │ │             │ │ │✅ 已合并│ │              │
│  │ └─────────┘ │ │             │ │ └─────────┘ │              │
│  └─────────────┘ └─────────────┘ └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 任务详情

```
┌─────────────────────────────────────────────────────────────────┐
│  ← 返回任务列表                                                  │
├─────────────────────────────────────────────────────────────────┤
│  📋 修复登录页面 Bug                                             │
│  ─────────────────────────────────────────────────────────────  │
│  状态: 🔵 进行中    Agent: Claude    分支: feature/fix-login    │
│  创建: 2024-01-02 14:30    耗时: 5:23                           │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  [💬 聊天]  [📝 Diff]  [📜 日志]                         │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │                                                         │   │
│  │  User: 帮我修复登录页面的 Bug，用户反馈无法登录         │   │
│  │                                                         │   │
│  │  Claude: 我来检查登录相关的代码...                      │   │
│  │  我发现问题在 src/auth/login.ts:42                      │   │
│  │  正在修复...                                            │   │
│  │                                                         │   │
│  │  [输入框]                         [发送]                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  [⏸️ 暂停]  [🔄 切换Agent]  [📤 导出]  [✅ 完成]  [🗑️ 删除] │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 并行任务执行

```
┌─────────────────────────────────────────────────────────────────┐
│  并行任务监控                                          [最小化] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Task 1: 修复登录Bug          │ 🤖 Claude │ ⏱️ 5:23 │ 🔵 │   │
│  │ ├─ 正在分析 src/auth/login.ts                          │   │
│  │ └─ [查看详情] [暂停]                                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Task 2: 优化首页性能          │ 🤖 Gemini │ ⏱️ 2:11 │ 🔵 │   │
│  │ ├─ 正在优化图片加载...                                  │   │
│  │ └─ [查看详情] [暂停]                                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Task 3: 添加单元测试          │ 🤖 Codex  │ ⏱️ 8:45 │ 🟡 │   │
│  │ ├─ ✅ 完成，等待审核                                    │   │
│  │ └─ [查看Diff] [合并] [拒绝]                             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  CPU: 45%  内存: 2.1GB  活跃任务: 2/3                           │
└─────────────────────────────────────────────────────────────────┘
```

### 2.4 Git 集成

```
┌─────────────────────────────────────────────────────────────────┐
│  📝 任务 Diff 查看                                               │
├─────────────────────────────────────────────────────────────────┤
│  分支: feature/fix-login → main                                 │
│  变更: 3 文件, +42 行, -15 行                                   │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  📁 src/auth/login.ts                               +25 -10    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ - const token = await authenticate(user, pass);         │   │
│  │ + const token = await authenticate(user, pass, {        │   │
│  │ +   timeout: 5000,                                      │   │
│  │ +   retries: 3                                          │   │
│  │ + });                                                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  📁 src/auth/types.ts                                +12 -3    │
│  📁 tests/auth.test.ts                               +5 -2     │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  [✅ 合并到 main]  [📝 创建 PR]  [❌ 放弃更改]           │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

---

## Phase 3: Agent Orchestra (Agent 协作)

**目标**：实现 Agent 间的智能协作，自动化工作流

### 3.1 任务路由

```
┌─────────────────────────────────────────────────────────────────┐
│  🧠 智能任务分配                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  新任务: "重构用户认证模块并添加测试"                            │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  🤖 AI 建议拆分为 2 个子任务:                            │   │
│  │                                                         │   │
│  │  1. 重构用户认证模块                                     │   │
│  │     推荐: Claude (擅长代码重构)                          │   │
│  │     预计: 15-20 分钟                                     │   │
│  │                                                         │   │
│  │  2. 添加单元测试                                         │   │
│  │     推荐: Codex (擅长测试生成)                           │   │
│  │     依赖: 任务 1 完成后                                  │   │
│  │     预计: 10-15 分钟                                     │   │
│  │                                                         │   │
│  │  [接受建议] [手动调整] [单任务执行]                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 工作流编排

```
┌─────────────────────────────────────────────────────────────────┐
│  🔄 工作流: 功能开发流程                                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐ │
│  │  需求分析 │───▶│  代码实现 │───▶│  测试编写 │───▶│  代码审查 │ │
│  │  Gemini  │    │  Claude  │    │  Codex   │    │  Claude  │ │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘ │
│       │              │               │               │         │
│       ▼              ▼               ▼               ▼         │
│    ✅ 完成        🔵 进行中        ⏸️ 等待          ⏸️ 等待    │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│  进度: ████████░░░░░░░░ 50%                                     │
│  预计完成: 25 分钟后                                             │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 Agent 能力矩阵

```
┌─────────────────────────────────────────────────────────────────┐
│  🤖 Agent 能力配置                                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  任务类型          │ Claude │ Gemini │ Codex │ Kiro            │
│  ──────────────────┼────────┼────────┼───────┼────────         │
│  代码重构          │  ⭐⭐⭐  │  ⭐⭐   │  ⭐⭐  │  ⭐⭐           │
│  Bug 修复          │  ⭐⭐⭐  │  ⭐⭐   │  ⭐⭐  │  ⭐⭐⭐          │
│  测试编写          │  ⭐⭐   │  ⭐⭐   │  ⭐⭐⭐ │  ⭐⭐           │
│  文档生成          │  ⭐⭐   │  ⭐⭐⭐  │  ⭐⭐  │  ⭐⭐           │
│  代码审查          │  ⭐⭐⭐  │  ⭐⭐⭐  │  ⭐⭐  │  ⭐⭐           │
│  性能优化          │  ⭐⭐   │  ⭐⭐   │  ⭐⭐⭐ │  ⭐⭐           │
│                                                                 │
│  [自定义能力评分]                                                │
└─────────────────────────────────────────────────────────────────┘
```

---

## 功能优先级矩阵

### 影响力 vs 实现难度

```
                        高影响力
                            │
         ┌──────────────────┼──────────────────┐
         │                  │                  │
         │  ★ 并行任务执行   │  ★ 工作流编排     │
         │  ★ 任务状态追踪   │  ★ 智能任务路由   │
         │  ★ Git Worktree  │  ★ Agent协作     │
         │                  │                  │
    低难度────────────────────────────────────────高难度
         │                  │                  │
         │  ★ 会话持久化     │  ★ 上下文摘要     │
         │  ★ Agent切换     │  ★ 能力矩阵       │
         │  ★ 任务面板UI    │                  │
         │                  │                  │
         └──────────────────┼──────────────────┘
                            │
                        低影响力
```

### 推荐实现顺序

| 优先级 | 功能 | 所属阶段 | 预计工时 | 价值 |
|--------|------|----------|----------|------|
| P0 | 会话持久化 | Phase 1 | 3-5 天 | 解决数据丢失 |
| P0 | 任务面板 UI | Phase 2 | 5-7 天 | 提供全局视角 |
| P1 | 并行任务执行 | Phase 2 | 7-10 天 | 核心差异化 |
| P1 | Git Worktree | Phase 2 | 5-7 天 | 任务隔离 |
| P2 | Agent 切换保持上下文 | Phase 1 | 3-5 天 | 提升体验 |
| P2 | 任务 Diff 查看 | Phase 2 | 3-5 天 | 审核能力 |
| P3 | 智能任务路由 | Phase 3 | 7-10 天 | 智能化 |
| P3 | 工作流编排 | Phase 3 | 10-14 天 | 自动化 |

---

## 竞品对比

| 功能 | Opencode (现状) | Cursor | Vibe Kanban | Opencode (目标) |
|------|-----------------|--------|-------------|-----------------|
| Chat 交互 | ✅ | ✅ | ❌ | ✅ |
| 多 Agent | ✅ | ❌ | ✅ | ✅ |
| 任务管理 | ❌ | ❌ | ✅ | ✅ |
| 并行执行 | ❌ | ❌ | ✅ | ✅ |
| Git 集成 | 基础 | 基础 | 深度 | 深度 |
| Kanban 视图 | ❌ | ❌ | ✅ | ✅ |
| Agent 协作 | ❌ | ❌ | ❌ | ✅ |
| 桌面应用 | ✅ | ✅ | ❌ | ✅ |

**Opencode 的差异化定位**：

> **Chat + Task + Orchestration = 下一代 AI 编码助手**

既保留 Chat 的便捷性，又具备任务管理的系统性，还能实现多 Agent 协作。

---

## 用户场景

### 场景 1: 个人开发者日常

```
早上 9:00
├─ 打开 Opencode，查看昨天未完成的任务
├─ Task 1 "修复登录Bug" 状态: 待审核
│  └─ 查看 Diff，确认无误，点击合并
├─ Task 2 "添加用户模块" 状态: 进行中
│  └─ 继续昨天的对话，让 Claude 完成剩余部分
└─ 创建新任务 "优化首页性能"，分配给 Gemini 并行执行

中午 12:00
├─ Task 2 完成，审核通过
├─ Task 3 进行中
└─ 午休，任务后台继续运行

下午 14:00
├─ Task 3 完成，有冲突
│  └─ 在 Opencode 中解决冲突，合并
└─ 创建下午的任务清单...
```

### 场景 2: 团队协作（未来）

```
项目经理在 Opencode 中创建任务
├─ Task: "实现用户认证模块"
│  ├─ 子任务 1: 设计 API (Gemini)
│  ├─ 子任务 2: 实现后端 (Claude)
│  └─ 子任务 3: 编写测试 (Codex)
│
└─ 工作流自动执行
   ├─ Gemini 完成设计 → 自动触发 Claude
   ├─ Claude 完成实现 → 自动触发 Codex
   └─ 全部完成 → 通知项目经理审核
```

---

## 技术架构演进

### 当前架构

```
┌─────────────────────────────────────────────────────────────┐
│                        Frontend (React)                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                  │
│  │ ChatPanel│  │ Sidebar  │  │ConfigPane│                  │
│  └──────────┘  └──────────┘  └──────────┘                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ Tauri IPC
┌─────────────────────────────────────────────────────────────┐
│                      Backend (Rust)                          │
│  ┌──────────────┐  ┌──────────────┐                        │
│  │ CLI Executor │  │ MCP Manager  │                        │
│  └──────────────┘  └──────────────┘                        │
└─────────────────────────────────────────────────────────────┘
```

### 目标架构

```
┌─────────────────────────────────────────────────────────────┐
│                        Frontend (React)                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ ChatPanel│  │ TaskBoard│  │ DiffView │  │ Workflow │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ Tauri IPC
┌─────────────────────────────────────────────────────────────┐
│                      Backend (Rust)                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ TaskManager  │  │WorktreeManager│ │ ProcessPool  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ CLI Executor │  │ MCP Manager  │  │  GitService  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────────────────────────────────────────┐      │
│  │              SQLite (tauri-plugin-sql)            │      │
│  └──────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

---

## 总结

### 核心建议

1. **保持 Chat 为主**：不要完全抛弃 Chat，它是最直观的交互方式
2. **渐进式增强**：先 Chat+，再 Task Hub，最后 Orchestra
3. **差异化定位**：多 Agent + 任务管理 + Git 深度集成
4. **用户体验优先**：每个功能都要解决真实痛点

### 近期行动项

1. **本周**：实现会话持久化（tauri-plugin-store）
2. **下周**：添加任务面板 UI 原型
3. **本月**：完成并行任务执行 + Git Worktree

### 长期愿景

> Opencode = **个人 AI 开发团队**
>
> 你是项目经理，Claude、Gemini、Codex、Kiro 是你的团队成员。
> 你分配任务、审核代码、协调资源，他们并行工作、各展所长。
